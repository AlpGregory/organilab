{% extends 'base.html' %}
{% load i18n static laboratory %}
{% load user_rol_tags %}

{# CSS #}
{% block css %}
<link href="{% static 'css/permission_table_style.css' %}" rel="stylesheet" media="all">
{% endblock css %}

{% block content %}

{% if perms.laboratory.add_laboratory %}
    <a class="btn btn-sm btn-primary" type="button" href="{% url 'auth_and_perms:add_user' %}" title="{% trans 'Add User' %}"><i class="fa fa-user-plus"></i> {% trans 'User' %}</a>
{% endif %}

{% for node in nodes %}
<div class="row">
    <div class="{{node.1}}">
        <div class="bs-callout bs-callout-{{node.2}}">
            <div class="row" id="rols">
                <div class="row">
                    <h4 style="margin-left: 3%;">{{node.0.node}}</h4>
                </div>
                <div class="role">
                    {% include 'auth_and_perms/tabla.html' with object=node.0.node %}
                </div>

                <div class="row">
                    <ul style="padding: 0px; margin-left: 3%;">
                        <li class="rolcontainer" rol="{{node.0.node.pk}}" title="{% trans 'Add new rol' %}" confirmbtntext="{% trans 'Add' %}" data-addbtn="1"><span class="btn btn-sm btn-success rolbtnadd" ><i class="fa fa-plus"></i> {% trans 'Rol' %}</span></li>
                        <li class="rolcontainer" title="{% trans 'Manage Users' %}"><a class="btn btn-sm btn-warning userbtnadd" type="button" data-id="{{node.0.node.pk}}" data-url="{% url 'auth_and_perms:addusersorganization' node.0.node.pk %}"><i class="fa fa-users" ></i> {% trans 'Users' %}</a></li>
                        {% if perms.laboratory.add_laboratory %}
                            <li class="rolcontainer"><a class="btn btn-sm btn-primary" type="button" href="{% url 'laboratory:create_lab' node.0.node.pk %}?lab={{laboratory|get_lab_pk}}" title="{% trans 'Add Laboratory' %}">
                                <i class="fa fa-plus"></i> {% trans 'Laboratory' %}</a></li>
                        {% endif %}
                    </ul>
                </div>
            </div>
            
            <div class="row" style="margin-top: 3%;">
                {% if node.0.labs %}
                <a class="btn" data-bs-toggle="collapse" href="#collapse{{node.0.node.pk}}" role="button" aria-expanded="false" aria-controls="collapseExample"><h4>{% trans 'Laboratories' %} <i class="fa fa-angle-down"></i></h4></a>
                {% else %}
                    <h4 style="margin-left: 1%;">{% trans 'Laboratories' %}</h4>
                {% endif %}
                <div id="collapse{{node.0.node.pk}}">
                    <ul>
                    {% for lab in node.0.labs %}
                    <li><a class="btn btn-sm" type="button" href="{% url  'laboratory:labindex' lab.pk %}"><i class="fa fa-eye fa-2x"></i> {{lab}}</a></li>
                    {% empty %}
                        <li><a class="btn btn-sm" type="button">{% trans "Organization doesn't have laboratories" %}</a></li>
                    {% endfor %}
                </ul>
                </div>
            </div>
            <div class="row">
                <div class="wrapper" style="overflow: auto;">
                    <table id="permissionTable{{node.0.node.pk}}" class="table table-bordered table-hover table-striped w-100 permissionTable">
                    <thead>
                        <tr>
                            <th>{% trans "Administrators users"%}</th>
                            {% for rol in node.0.node.rol.all %}
                                <th>{{rol.name}}</th>
                            {% endfor %}

                        </tr>
                    </thead>
                    <tbody>
                        {% for user in node.0.users %}
                            <tr data-id="{{user.pk}}" data-name="{% if user.get_full_name %}{{user.get_full_name}}{% else %}{{user}}{% endif %}">
                                <td>
                                    {% if user.get_full_name %}{{user.get_full_name}}{% else %}{{user}}{% endif %}
                                </td>
                                {% for rol in node.0.node.rol.all %}
                                    <td>
                                        {% check_user_rol user rol as checkrol %}
                                            <input type="checkbox" autocomplete="off" data-widget="CheckboxInput"  class="flat {% if checkrol %}checkrol{% endif %}" data-url="{% url 'auth_and_perms:updateuserrol' user.pk rol.pk %}" style="position: absolute; opacity: 0;">
                                            <ins class="iCheck-helper"></ins>
                                    </td>
                                {% endfor %}
                            </tr>
                        {% endfor %}

                    </tbody>
                </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% endfor %}

<div id="addrolform" title="{% trans 'Please enter a valid name' %}"
     url="{% url 'auth_and_perms:api-rol-list' %}"
     class="hidden" style="display:none">
    <input type="text" id="rolname" class="swal2-input" placeholder="{% trans 'Rol name' %}" />
</div>

<div id="addusermodal" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <form id="adduserform" method="post">
          {% csrf_token %}
          <input type="hidden" id="pk" name="pk" value=0>
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">{% trans 'Manage Users' %}</h4>
          </div>
          <div class="modal-body">
              {{adduserform.as_horizontal}}
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">{% trans 'Cancel' %}</button>
            <button type="submit" class="btn btn-primary">{% trans 'Save' %}</button>
          </div>
        </form>
      </div>
    </div>
  </div>


{% endblock %}

{% block js %}
{{block.super}}

<script src="{% static 'js/auth_and_perms/organization_manager.js' %}"></script>

{% endblock%}