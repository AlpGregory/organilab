{% extends 'label_index.html' %}
{% load i18n %}
{% load static %}
{% load urlname_tags %}
{% load organilab_tags %}
{% block pre_head %}
    {% define_urlname_action 'step_one' %}
    {% define_urlname_action 'step_two' %}
    {% define_urlname_action 'step_three' %}
    {% define_urlname_action 'step_four' %}
    {% define_urlname_action 'update_substance' %}
    {% define_urlname_action 'get_recipient_size' %}
    {% define_urlname_action 'get_danger_indication' %}
    {% define_urlname_action 'prudence' %}
{% endblock %}
{# CSS #}
{% block css %}

{% endblock css %}
{% block js %}
{{block.super}}

    <script>
        var json_representation=`{{templateinstance.json_representation|safe}}`;
        document.url_get_recipient_size = "{% url 'sga:get_recipient_size' org_pk organilabcontext 0 %}";
        document.clean_canvas_editor = true;
        document.urls={
            'danger_indication_url': '{% url 'sga:get_danger_indication' org_pk organilabcontext %}',
            'prudence_advice_url': '{% url 'sga:prudence' org_pk organilabcontext %}',

        };
    </script>
{{form.media}}

<script>
    $("#editor_save").on('click', function(e){
        const event = new CustomEvent("serializeall", { detail: $("#id_json_representation")[0] });
        const savepngevent = new CustomEvent("savepng", { detail:
               {callback: data =>{ $("#id_preview").val(data); $("#formeditor").submit();} ,
               width: 6,
               height: 8
              }
        });

        let canvas = $("#editoriframe").contents().find("#canvas")[0];
        canvas.dispatchEvent(event);
        canvas.dispatchEvent(savepngevent);

        //$("#formeditor").submit();
    });

    $("#editoriframe").ready(function(){
        let canvas = $("#editoriframe").contents().find("#canvas")[0];
        const event = new CustomEvent("loadjson", { detail: {data: JSON.parse(json_representation), dontClear: false}});
        canvas.dispatchEvent(event);
    });

</script>

{% endblock %}

{% block extrameta%}{% endblock extrameta %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-12">
          {% include 'academic/substance/steps.html' %}
            <div class="row">
                <div class="col-md-12">
                    <div class="text-center">
{% trans 'Use save before finish' %}<br><br>
                        <form id="formeditor" action="" method="post">
{% csrf_token %}
                            {{editorform.as_inline}}
                        </form>
 <button id="editor_save" type="submit" class="btn btn-outline-success text-center" > <i class="fa fa-floppy-o"></i> {% trans 'Save' %} </button>
 </div>

                </div>
                <div class="col-md-12">
<div class="m-3 card">
    <div class="card-body">
    <iframe id="editoriframe" src="{{request.scheme}}://{{ request.get_host }}{% url 'sga:index_editor' org_pk=org_pk %}?app_label=sga&model=templatesga&object_id={{instance.template.pk}}&field=json_representation" width="100%" height="600px"></iframe>
    </div>
</div>

                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}