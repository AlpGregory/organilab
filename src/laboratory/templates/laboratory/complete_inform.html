{% extends 'base.html' %}
{% load static i18n %}

{% block extra_css %}
    <link rel="stylesheet" href="https://cdn.form.io/formiojs/formio.full.min.css">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 id="form_name" class="text-center"> </h1>
    <button id="observation" class="btn btn-success float-end" type="button" ><i class="fa fa-eye" aria-hidden="true"></i> {% trans 'Observations' %}</button>
    <div class="clearfix"></div>
    <div class="row">
        <div id="left-col" class="col-md-12">
            <form id="inform_form">
                {% csrf_token %}
                <div id="formio"></div>
                {% if inform.status == 'Eraser' %}
                    <button type="button"  class="btn btn-success" onclick="saveForm('In Review')">{% trans 'Send for review' %}</button>
                {% endif %}
                {% if inform.status == 'In Review' %}
                    <button type="button"  class="btn btn-danger" onclick="saveForm('Finalized')">{% trans 'Finalize' %}</button>
                {% endif %}
            </form>
        </div>
        <div id="right-col" class="d-none" style="margin-top:-15px;">
            {% include 'laboratory/comments.html' %}
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
<script src="{% static 'formio/formio.full.min.js' %}"></script>
<script type="text/javascript">
const urls ={
    edit:"{% url 'laboratory:complete_inform' laboratory inform.pk %}",
    list: "{% url 'laboratory:get_informs' laboratory %}",
    add_comment:"{% url 'laboratory:api-inform-list' %}",
};


$.ajax({
            url: urls['add_comment'],
                type: "GET",
                dataType: "json",
                headers: {
                    "X-Requested-With": "XMLHttpRequest",
                    "X-CSRFToken": getCookie("csrftoken"),
                },
                success: (success) => {
                document.querySelector('#listado').innerHTML=success.data;

                },
            });

var schema = {{ schema | safe }};
document.getElementById("form_name").textContent = "{{inform.name}}";

var components = { components: schema["components"] };

window.onload = function(schema) {

    Formio.createForm(document.getElementById('formio'), components);
    }
   let status = "{{inform.status}}"
   let title = status == 'Eraser'?"{% trans 'Do you want to send the report for review?' %}":"{% trans 'Do you want to finish the report?' %}";
   var message ={
    title:title,
    text: "{% trans 'Discarding cannot be undone.' %}",
    icon: "warning",
    deny: "{% trans 'Cancel' %}",
    confirm: "{% trans 'Save' %}",
    }
   const result ={
    title:"{% trans 'Saved' %}",
    text: "{% trans 'Discarding cannot be undone.' %}",
    icon: "success",
    }
    $('#observation').click(()=>{
     let right= document.querySelector('#right-col')
     if(right.className=="col-sm-6"){
        document.querySelector('#left-col').classList="col-sm-12"
        document.querySelector('#right-col').classList="d-none"
    }else{
        document.querySelector('#left-col').classList="col-sm-6"
        document.querySelector('#right-col').classList="col-sm-6"
     }
    })

function save_comment(){
     Swal.fire({
      title: 'Agregar nuevo comentario',
      input: 'textarea'
      }).then(function(result) {
      if (result.value) {
        $.ajax({
                url: urls['add_comment'],
                type: "POST",
                dataType: "json",
                data: {'comment':result.value,'inform':8},
                headers: {
                    "X-Requested-With": "XMLHttpRequest",
                    "X-CSRFToken": getCookie("csrftoken"),
                },
                success: (success) => {
                    Swal.fire(
                        result['title'],
                        result['text'],
                        result['icon']
                        )
                                                        document.querySelector('#listado').innerHTML=success.data;

                },
            });
      }
      })
    }


           function edit_comment(pk){
           localStorage.setItem('comment', pk);
            $.ajax({
            url: "{% url 'laboratory:api-inform-list' %}"+pk,
                type: "GET",
                dataType: "json",
                headers: {
                    "X-Requested-With": "XMLHttpRequest",
                    "X-CSRFToken": getCookie("csrftoken"),
                },
                success: (success) => {
            Swal.fire({
            title: 'Editar comentario',
            input: 'textarea',
            inputValue:success.comment
            }).then(function(result) {
                update_comment(result.value)
                })
                            }
                                });
            }
    function update_comment(comment){

            let url ="{% url 'laboratory:api-inform-detail' 0 %}".replace('0',localStorage.getItem('comment'));
            localStorage.removeItem('comment');
            $.ajax({
                url: url,
                type: "PUT",
                dataType: "json",
                data: {'comment':comment},
                headers: {
                    "X-Requested-With": "XMLHttpRequest",
                    "X-CSRFToken": getCookie("csrftoken"),
                },
                success: (success) => {
                    Swal.fire(
                        result['title'],
                        result['text'],
                        result['icon']
                        )
                                                        document.querySelector('#listado').innerHTML=success.data;

                },
            });
      }
    function delete_comment(comment){

            let url ="{% url 'laboratory:api-inform-detail' 0 %}".replace('0',comment);

    Swal.fire({
        title: "Eliminar el comentario",
        text: "Â¿Deseas eliminar el comentario?",
        icon: "error",
        confirmButtonText: "Si",
        denyButtonText: "No",
        showDenyButton: true,
        showCloseButton: true
        }).then((result) => {
        if (result.isConfirmed) {
            $.ajax({
                url: url,
                type: "DELETE",
                dataType: "json",
                headers: {
                    "X-Requested-With": "XMLHttpRequest",
                    "X-CSRFToken": getCookie("csrftoken"),
                },
                success: (success) => {
                                document.querySelector('#listado').innerHTML=success.data;

                    Swal.fire(
                       "Se elimino correctamente",
                        )
                },
            });
      }
      });
      }
</script>
<script src="{% static 'js/formio.js'%}"></script>

{% endblock %}

</html>