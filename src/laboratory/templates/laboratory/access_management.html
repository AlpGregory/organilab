{% extends 'base.html' %}
{% load i18n static laboratory gtsettings %}
{% block pre_head %}
    {% define_true  "use_datatables" %}
{% endblock %}
{% block title %}{% trans 'Access List' %}{% endblock %}
{% block content %}
  <div class="row justify-content-center">
    <div class="col-md-10">
      <h3 class="heading-1 text-center" ><span> {% trans 'Access List' %}</span></h3>
      <div class="card mb-4">
        <div class="card-body">
          <div class="card-title titles mb-2">
            <h2>{% trans 'Laboratories list' %}</h2>
            <ul class="nav navbar-right panel_toolbox"></ul>

          </div>
          <div class="table-responsive">
            <table id="labs" class="table table-striped table-bordered">
              <thead>
              <tr >
                <th class="text-center">{% trans 'Name' %}</th>
                <th class="text-center">{% trans 'Phone number' %}</th>
                <th class="text-center">{% trans 'Location' %}</th>
                <th class="text-center">{% trans 'Organization' %}</th>
                <th class="text-center">{% trans 'Actions' %}</th>
              </tr>
              </thead>
              <tbody class="text-center">
              {% for lab in labs %}
              <tr>
                <td>{{lab.name}}</td>
                <td>{{lab.phone_number}}</td>
                <td>{{lab.location}}</td>
                <td>{{lab.organization}}</td>
                <td class="align-middle">
                  <a class="btn btn-primary btn-sm" data-bs-toggle="tooltip" title="{% trans 'User management' %}" href="{% url 'laboratory:users_management' lab.pk %}"><i class="fa fa-users"></i></a>
                </td>
              </tr>
              {% endfor %}
              </tbody>
              <tfoot>
              <tr>
                <th class="text-center">{% trans 'Name' %}</th>
                <th class="text-center">{% trans 'Phone number' %}</th>
                <th class="text-center">{% trans 'Location' %}</th>
                <th class="text-center">{% trans 'Organization' %}</th>
                <th class="text-center">{% trans 'Actions' %}</th>
              </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-body">
          <div class="card-title titles">
            <h2>{% trans 'Organizations list' %}</h2>
            <ul class="nav navbar-right panel_toolbox"></ul>
          </div>
          <div class="table-responsive">
            <table id="orgs" class="table table-striped table-bordered ">
              <thead>
              <tr>
                <th class="text-center">{% trans 'Name' %}</th>
                <th class="text-center">{% trans 'Laboratories' %}</th>
                <th class="text-center">{% trans 'Actions' %}</th>
              </tr>
              </thead>
              <tbody class="text-center">
              {% for node in orgs %}
              <tr>
                <td>{{node.name}}</td>
                <td>
                  <ul style="list-style-type:none;">
                    {% for lab in node.laboratory_set.all %}
                    <li>{{lab}}</li>
                    {% empty %}
                    <li>{% trans 'There are not laboratories' %}</li>
                    {% endfor %}
                  </ul>
                </td>
                <td class="text-center align-middle">
                  <button type="button" class="btn btn-success btn-sm" data-bs-toggle="tooltip" title="{% trans 'Add organization' %}" onclick="update_pK_parent(this)" id="{{ node.pk }}" data-bs-toggle="modal" data-bs-target="#organizationsavemodal"> <i class="fa fa-university"></i></button>
                  <a class="btn btn-primary btn-sm" data-bs-toggle="tooltip" title="{% trans 'Reactive presence' %}" href="{% url 'laboratory:organizationreactivepresence' node.pk %}" target="_blank"><i class="fa fa-medkit"></i></a>
                  <button type="button" class="btn btn-success btn-sm" data-bs-toggle="tooltip" title="{% trans 'Edit organization' %}" onclick="add_pk(this)"  data-bs-toggle="modal" data-bs-target="#organizationeditmodal" data-id="{{ node.pk }}" data-name="{{ node.name }}"> <i class="fa fa-cogs" aria-hidden="true"></i></button>
                </td>
              </tr>
              {% endfor %}
              </tbody>
              <tfoot>
              <tr>
                <th class="text-center">{% trans 'Name' %}</th>
                <th class="text-center">{% trans 'Laboratories' %}</th>
                <th class="text-center">{% trans 'Actions' %}</th>
              </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
      <div class="d-flex justify-content-center">
             <button type="button" class="btn btn-success btn-lg mt-4"
                  data-bs-toggle="tooltip" title="{% trans 'Add organization' %}"
                  onclick="update_pK_parent(this)" id="0" data-bs-toggle="modal"
                  data-bs-target="#organizationsavemodal"> <i class="fa fa-university"></i></button>
      </div>


    </div>
  </div>
  <div id="organizationsavemodal" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <form action="" method="post">
          {% csrf_token %}
          <input type="hidden" id="pk" name="pk" value=0>
          <div class="modal-header">
             <h4 class="modal-title">{% trans 'Add descendant organization' %}</h4>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            {{ form.as_horizontal }}
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans 'Cancel' %}</button>
            <button type="submit" class="btn btn-primary">{% trans 'Save' %}</button>
          </div>
        </form>
      </div>
    </div>
  </div>

 <div id="organizationeditmodal" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <form action="{% url 'laboratory:edit_organization' %}" method="post">
          {% csrf_token %}
          <input type="hidden" name="org_pk" id="org_pk">

          <div class="modal-header">
            <h4 class="modal-title">{% trans 'Edit descendant organization' %}</h4>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label>{% trans 'Name' %}</label>
              <input class="form-control" id="org_name" name="name" required="true">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans 'Cancel' %}</button>
            <button type="submit" class="btn btn-primary">{% trans 'Save' %}</button>
          </div>
        </form>
      </div>
    </div>
  </div>
{% endblock %}
{% block js %}
  <script>
    $(document).ready(function() {
      $('#labs').DataTable({
         "dom": 'lfrtip'
      });
      $('#orgs').DataTable({
         "dom": 'lfrtip'
      });
      $('.select2-container').width('100%');
    });
    function update_pK_parent(element){
      $('#pk').val(parseInt($(element).attr('id')));
      $("#organizationsavemodal").modal("show");
    }
    function add_pk(element){
      $('#org_pk').val(parseInt($(element).attr('data-id')));
      $("#organizationeditmodal").modal("show");
      $('#org_name').val($(element).attr('data-name'));
      }
  </script>
{% endblock %}